{{#section 'head'}}
  <style media="screen">
  .select2-container .select2-search,
    .select2-container .select2-search__field {
        width: 100% !important;
    }
    .popover-content{
      height: 100px;
      padding: 4px;
      font-size: 11px;
      width: 400px; /* Max Width of the popover (depending on the container!) */
    }
    .popover-title{
      text-align: left;
      background-color: #2A3F54;
      border-color: #2A3F54;
      color: white;
    }
    .campoMoreInfo{
      font-weight: bold;
    }
  </style>
{{/section}}

<div class="row">
  <div class="col-sm-6" data-step="1" data-intro="First of all, choose the ROOM">
    <select id="roomID" name="getAllSiteBuildingRoom" style="width:100%;">
      <option value="">SELECT THE ROOM</option>
      {{#each getAllSiteBuildingRoom}}
        <option value="{{RoomID}}">{{unidade}} - {{NameBuilding}} - {{NameRoom}}</option>
      {{/each}}
    </select>
  </div>
</div>

<div class="row" style="margin-top:15px;">
  <div class="col-md-12">
    <div class="x_panel">
      <div class="x_content">
        <div id="calendar" data-step="2" data-intro="After choosing the room, the system will display in the calendar all the events marked during the current month. You can display the events by month, week, day or list"></div>
      </div>
    </div>
  </div>
</div>

<div id="modalNewEvent" class="modal" role="dialog">
  <div class="modal-dialog" style="width:90%;">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <div class="row">
          <div class="col-sm-6">
            <h5 class="modal-title">New Internal Event - <span id="dateTitle"></span> in <span id="roomTitle"></span></h5>
          </div>
          <div class="col-sm-6" data-step="3" data-intro="Select an event from the list to fill in the fields automatically">
            <select class="form-control" name="" id="selectReuseEvent" style="width:100%;">
              <option value="">Reuse Info Event:</option>
              {{#each myEvents}}
                <option value="{{EventCode}}">{{EventCode}} - {{title}}</option>
              {{/each}}
            </select>
          </div>
        </div>
      </div>
      <form id="formNewEvent" action="index.html" method="post">
        <input type="hidden" name="dateNewEvent" id="dateNewEvent">
        <input type="hidden" name="roomIDNewEvent" id="roomIDNewEvent">
        <div class="modal-body">
          <div class="container">
            <div class="row">
              <div class="col-sm-12">
                <div class="panel panel-primary">
                  <div class="panel-heading">Main information</div>
                  <div class="panel-body">
                    <div class="row">
                      <div class="col-sm-3">
                        <div class="col-sm-6">
                          <label for="startTimeNewEvent">Start</label>
                          <input type="time" name="startTimeNewEvent" id="startTimeNewEvent" class="form-control" data-step="4" data-intro="Start Hour" required>
                        </div>
                        <div class="col-sm-6">
                          <label for="endTimeNewEvent">End</label>
                          <input type="time" name="endTimeNewEvent" id="endTimeNewEvent" class="form-control" data-step="5" data-intro="End Hour" required>
                        </div>
                      </div>
                      <div class="col-sm-4">
                        <label for="nameNewEvent"></label>
                        <input type="text" name="nameNewEvent" id="nameNewEvent" class="form-control" placeholder=" Event Name" data-step="6" data-intro="Event Name" required>
                      </div>
                      <div class="col-sm-3" data-step="7" data-intro="Responsible by Event">
                        <label for="responsibleNewEvent"></label>
                        <select id="responsibleNewEvent" name="responsibleNewEvent" style="width:100%;">
                          <option value="">RESPONSIVE BY EVENT</option>
                          {{#each allActiveUser}}
                            <option value="{{matricula}}">{{pad matricula 4 0}} - {{toTitleCase nomeusuario}}</option>
                          {{/each}}
                        </select>
                      </div>
                      <div class="col-sm-2" data-step="8" data-intro="Departament">
                        <label for="iddepartamento"></label>
                        <select id="iddepartamento" name="iddepartamento" style="width:100%;">
                          <option value="">DEPARTAMENT</option>
                          {{#each allDepartament}}
                            <option value="{{iddepartamento}}">{{toTitleCase nomedepartamento}}</option>
                          {{/each}}
                        </select>
                      </div>
                    </div>
                    <div class="row" style="margin-top:7px;">
                      <div class="col-sm-12">
                        <span>Reschedule Event?</span>
                        <input id="rescheduleN" style="margin-left: 5px;" type="radio" name="reschedule" value="No" checked> <label for="rescheduleN">No</label>
                        <input id="rescheduleS" style="margin-left: 5px;" type="radio" name="reschedule" value="Yes"> <label for="rescheduleS">Yes</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-sm-4">
                <div class="panel panel-primary">
                  <div class="panel-heading">Equipaments</div>
                  <div class="panel-body" data-step="9" data-intro="You can request equipaments to your event">
                    <div class="row">
                      <div class="col-sm-8">
                        Need Computer/Notebook ?
                      </div>
                      <div class="col-sm-4 text-right" data-step="10" data-intro="If you need a computer/notebook, check YES">
                         <input id="needcomputerN" type="radio" name="needcomputer" value="No"> <label for="needcomputerN">No</label>
                         <input id="needcomputerS" style="margin-left: 5px;" type="radio" name="needcomputer" value="Yes"> <label for="needcomputerS">Yes</label>
                      </div>
                    </div>
                    <div class="row" style="margin-top:7px;">
                      <div class="col-sm-7">
                        Need DataShow ?
                      </div>
                      <div class="col-sm-5 text-right" data-step="11" data-intro="If you need a datashow, check YES">
                         <input id="needDataShowN" type="radio" name="needDataShow" value="No"> <label for="needDataShowN">No</label>
                         <input id="needDataShowS" style="margin-left: 5px;" type="radio" name="needDataShow" value="Yes"> <label for="needDataShowS">Yes</label>
                      </div>
                    </div>
                    <div class="row" style="margin-top:7px;">
                      <div class="col-sm-4">
                        Video Conference
                      </div>
                      <div class="col-sm-8 text-right">
                          <label for="videoFrom">From:</label>
                          <select class="" name="videoFrom" id="videoFrom" data-step="12" data-intro="Video conference from?">
                            <option value=""></option>
                            <option value="ADM">ADM</option>
                            <option value="Botafogo">Botafogo</option>
                            <option value="Urca">Urca</option>
                            <option value="Barra">Barra</option>
                          </select>
                          <label for="videoTo">To:</label>
                          <select class="" name="videoTo" id="videoTo" data-step="13" data-intro="Video conference to?">
                            <option value=""></option>
                            <option value="ADM">ADM</option>
                            <option value="Botafogo">Botafogo</option>
                            <option value="Urca">Urca</option>
                            <option value="Barra">Barra</option>
                            <option value="All">All</option>
                          </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-8">
                <div class="panel panel-primary">
                  <div class="panel-heading">Additional Information</div>
                  <div class="panel-body">
                    <textarea data-step="14" data-intro="If you want add more information of your event, please write here" name="additionalInformation" id="additionalInformation" rows="3" class="form-control btn-block"></textarea>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-sm-6">
                <div class="panel panel-primary" data-step="15" data-intro="Here you can insert names and amount of participants">
                  <div class="panel-heading">Participants</div>
                  <div class="panel-body">
                    <div class="row">
                      <div class="col-sm-2" data-step="16" data-intro="Amount of Parent">
                        <input type="number" min="0" name="qtdParentNewEvent" id="qtdParentNewEvent" class="form-control nParticipant" placeholder=" Nº Parent" style="padding-right: 2px;" data-toggle="tooltip" title="Nº Parent">
                      </div>
                      <div class="col-sm-2" data-step="17" data-intro="Amount of Pupil">
                        <input type="number" min="0" name="qtdPupilNewEvent" id="qtdPupilNewEvent" class="form-control nParticipant" placeholder=" Nº Pupil" data-toggle="tooltip" title="Nº Pupil">
                      </div>
                      <div class="col-sm-2" data-step="18" data-intro="Amount of Staff">
                        <input type="number" min="0" name="qtdStaffNewEvent" id="qtdStaffNewEvent" class="form-control nParticipant" placeholder=" Nº Staff" data-toggle="tooltip" title="Nº Staff">
                      </div>
                      <div class="col-sm-2" data-step="19" data-intro="Amount of Visitor">
                        <input type="number" min="0" name="qtdVisitorNewEvent" id="qtdVisitorNewEvent" class="form-control nParticipant" placeholder=" Nº Visitor" data-toggle="tooltip" title="Nº Visitor">
                      </div>
                      <div class="col-sm-4" data-step="20" data-intro="Sum of left input">
                        <input type="text" min="0" name="qtdTotalParticipant" id="qtdTotalParticipant" class="form-control" placeholder=" Total" disabled style="text-align: right;">
                      </div>
                    </div>
                    <div class="row" style="margin-top:5px;" data-step="21" data-intro="You can insert the type of participant and his name">
                      <div class="col-sm-2">
                        <select class="form-control font11" id="listTypeName" data-step="22" data-intro="Choose the type of participant">
                          <option data-group-name="parent" value="Parent">Parent</option>
                          <option data-group-name="pupil" value="Pupil">Pupil</option>
                          <option data-group-name="staff" value="Staff">Staff</option>
                          <option data-group-name="visitor" value="Visitor">Visitor</option>
                        </select>
                      </div>
                        <div class="col-sm-10" data-step="23" data-intro="After choose the type, write the name and press enter">
                          <input type="text" name="nameParticipantNewEvent" id="nameParticipantNewEvent" class="form-control" placeholder=" Insert name and press enter">
                        </div>
                    </div>
                    <div class="col-sm-12" style="margin-top:10px;">
                      <div class="row">
                        <div class="col-sm-3 text-center" data-step="24" data-intro="Amount of names of parent">
                          <button type="button" class="btn btn-primary" style="padding-top: 0px;padding-bottom: 0px;margin-bottom:3px;">Parent <span id="sumparent" class="badge">0</span></button>
                        </div>
                        <div class="col-sm-3 text-center" data-step="25" data-intro="Amount of names of pupil">
                          <button type="button" class="btn btn-primary" style="padding-top: 0px;padding-bottom: 0px;margin-bottom:3px;">Pupil <span id="sumpupil" class="badge">0</span></button>
                        </div>
                        <div class="col-sm-3 text-center" data-step="26" data-intro="Amount of names of staff">
                          <button type="button" class="btn btn-primary" style="padding-top: 0px;padding-bottom: 0px;margin-bottom:3px;">Staff <span id="sumstaff" class="badge">0</span></button>
                        </div>
                        <div class="col-sm-3 text-center" data-step="27" data-intro="Amount of names of visitor">
                          <button type="button" class="btn btn-primary" style="padding-top: 0px;padding-bottom: 0px;margin-bottom:3px;">Visitor <span id="sumvisitor" class="badge">0</span></button>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-sm-3 lineName" data-group-name="parent" style="padding-left:0px;">
                        </div>
                        <div class="col-sm-3 lineName" data-group-name="pupil" style="padding-left:0px;">
                        </div>
                        <div class="col-sm-3 lineName" data-group-name="staff" style="padding-left:0px;">
                        </div>
                        <div class="col-sm-3 lineName" data-group-name="visitor" style="padding-left:0px;">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="panel panel-primary" data-step="28" data-intro="Here you can choose the budget, select the products, insert the amount and press enter">
                  <div class="panel-heading">Menu</div>
                  <div class="panel-body">
                    <div class="row">
                      <div class="col-sm-12" data-step="29" data-intro="Select the budget">
                        <select id="id_budget" name="id_budget" style="width:100%;">
                          <option value="">SELECT THE BUDGET</option>
                          {{#each sess.budgets}}
                            <option data-setor="{{setor}}" data-grupo="{{grupo}}" data-conta="{{conta}}" data-ncont="{{nomecont}}" data-saldo="{{saldo}}" value="{{id_orca}}">{{pad setor 3 0}} {{pad grupo 3 0}} {{conta}} - {{nomecont}} - R${{addDecimalCases saldo}}</option>
                          {{/each}}
                        </select>
                      </div>
                    </div>
                    <div class="row" style="margin-top:5px;">
                      <div class="col-sm-10" data-step="30" data-intro="Choose all product">
                        <select id="listProduct" name="allProductActive" multiple style="width:100%;">
                          {{#each allProductActive}}
                            <option data-name-english="{{NameEnglish}}" data-name-port="{{NamePort}}" data-name-unit-engl="{{NameUnitEngl}}" data-name-unit-port="{{NameUnitPort}}" data-price={{Price}} data-event-product-id="{{EventProductID}}" value="{{EventProductID}}">{{NameEnglish}}/{{NamePort}} | {{NameUnitEngl}}/{{NameUnitPort}} | R$ {{Price}}</option>
                          {{/each}}
                        </select>
                      </div>
                      <div class="col-sm-2" data-step="31" data-intro="After choose products, insert the amount and press enter to save">
                        <input type="number" min="0" name="qtdProduct" id="qtdProduct" class="form-control" style="height:33px;" title="Insert amount and press enter" data-toggle="tooltip">
                      </div>
                    </div>
                    <div class="row" style="margin-top:10px;">
                      <div class="col-sm-12">
                        <div class="table-responsive">
                          <table class="table" id="tableItemEvent" style="margin-bottom: 0px;" data-step="32" data-intro="Table with all selected products">
                            <thead>
                              <th style="width:5%;border-right: 1px solid white;">Remove</th>
                              <th style="width:65%;border-right: 1px solid white;">Product</th>
                              <th style="width:10%;border-right: 1px solid white;">Amount</th>
                              <th style="width:20%;">Total (R$)</th>
                            </thead>
                            <tbody>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <input type="submit" value="Create" class="btn btn-success" id="submitFormNewEvent" data-step="33" data-intro="Click here to create new event">
        </div>
      </form>
    </div>
  </div>
</div>

<div id="modalRescheduleEvent" class="modal" role="dialog">
  <div class="modal-dialog" style="width:90%;">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <h5>
          Reschedule Event - <span id="rescheduleEventCode"></span> - <span id="rescheduleEventName"></span>
          (<span id="rescheduleEventStartTime"></span> - <span id="rescheduleEventEndTime"></span>)
        </h5>
      </div>
      <div class="modal-body">
        <form id="formReschedule">
          <input type="hidden" id="eventoToReschedule" name="eventoToReschedule">
          <input type="hidden" id="eventoToRescheduleRoom" name="eventoToRescheduleRoom">
          <input type="hidden" id="eventoToRescheduleStartTime" name="eventoToRescheduleStartTime">
          <input type="hidden" id="eventoToRescheduleEndTime" name="eventoToRescheduleEndTime">
          <div class="row">
            <div class="col-sm-3">
              <label for="FromDate">From</label>
              <input type="date" name="FromDate" id="FromDate" class="form-control" onkeyup="updateMinToDateField(this);" required>
            </div>
            <div class="col-sm-3">
              <label for="ToDate">To</label>
              <input type="date" name="ToDate" id="ToDate" class="form-control" required>
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div class="col-sm-12">
              <label class="checkbox-inline">
                <input type="checkbox" value="1" name="dayOfWeek">Monday
              </label>
              <label class="checkbox-inline">
                <input type="checkbox" value="2" name="dayOfWeek">Tuesday
              </label>
              <label class="checkbox-inline">
                <input type="checkbox" value="3" name="dayOfWeek">Wednesday
              </label>
              <label class="checkbox-inline">
                <input type="checkbox" value="4" name="dayOfWeek">Thursday
              </label>
              <label class="checkbox-inline">
                <input type="checkbox" value="5" name="dayOfWeek">Friday
              </label>
              <label class="checkbox-inline">
                <input type="checkbox" value="6" name="dayOfWeek">Saturday
              </label>
              <label class="checkbox-inline">
                <input type="checkbox" value="0" name="dayOfWeek">Sunday
              </label>
            </div>
          </div>
          <div class="row" style="margin-top:15px;">
            <div class="col-sm-3 text-right">
              <button type="submit" name="button" class="btn btn-primary btn-xs btn-block">Generate List of New Event</button>
            </div>
          </div>
          <div class="row" id="divRangeDate" style="margin-top:10px;display:none;">
            <div class="col-sm-12">
              <div class="panel panel-primary">
                <div class="panel-heading">
                  <div class="row">
                    <div class="col-sm-10">
                      <div style="margin-top:3px;">
                        <span>New desired dates</span> <span class="badge" id="amountEvent"></span>
                      </div>
                    </div>
                    <div class="col-sm-2 text-right">
                      <div>
                        <button onclick="confirmCreation();" type="button" name="button" class="btn btn-success btn-xs btn-block">Confirm Creation</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="panel-body" id="listDesiredDates">
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="divModalMoreInfo">
</div>

{{#section 'script'}}
<script type="text/javascript">

  $("#selectReuseEvent").on("change", function (e) {
    let EventCode = $("#selectReuseEvent").val()
    if('' === EventCode){
      resetForm()
    }else{
      let dataSend = {EventCode}

      $.ajax({
        url: '/find/fillout-form',
        type: 'POST',
        data: dataSend,
        dataType:'json',
        success: function(data) {
          document.getElementById('formNewEvent').reset()
          console.log(data);
          // debugger
          $('#startTimeNewEvent').val(data.EventFound.start.split(' ')[1])
          $('#endTimeNewEvent').val(data.EventFound.end.split(' ')[1])
          $('#nameNewEvent').val(data.EventFound.title)
          $('#responsibleNewEvent').val(data.EventFound.ResponsibleByEvent).trigger('change')
          $('#iddepartamento').val(data.EventFound.Departament_ID).trigger('change')
          $('#id_budget').val(data.EventFound.Budget_ID).trigger('change')

          $('input[name="needcomputer"][value='+ data.EventFound.NeedComputer +']').prop("checked", true)
          $('input[name="needDataShow"][value='+ data.EventFound.NeedDataShow +']').prop("checked", true)
          $("#videoFrom").val(data.EventFound.VideoFrom)
          $("#videoTo").val(data.EventFound.VideoTo)

          $('#id_budget').val(data.EventFound.Budget_ID).trigger('change')

          $('#additionalInformation').text(data.EventFound.AdditionalInformation)

          $('#qtdParentNewEvent').val(data.EventFound.Nparent)
          $('#qtdPupilNewEvent').val(data.EventFound.Npupil)
          $('#qtdStaffNewEvent').val(data.EventFound.Nstaff)
          $('#qtdVisitorNewEvent').val(data.EventFound.Nvisitor)

          let sum = 0
          $('.nParticipant').each(function(){
            if('' !== $(this).val()) sum += parseInt($(this).val())
          })
          $('#qtdTotalParticipant').val('Total: ' + sum)

          $('.lineName').empty()
          $('#sumparent').text(0)
          $('#sumpupil').text(0)
          $('#sumstaff').text(0)
          $('#sumvisitor').text(0)
          data.EventFound.guests.map(function(e){
            $('.lineName[data-group-name="'+ e.Type.toLowerCase() +'"]').append(
              '<div class="lineGuest new'+e.Type.toLowerCase()+'" data-group-name="'+ e.Type.toLowerCase() +'" data-yourname="'+ e.NameGuest +'">'
                +'<div class="col-sm-10" style="white-space:nowrap;padding-left:0px;padding-right:0px;" data-toggle="tooltip" title="'+ e.NameGuest +'">'
                  + e.NameGuest
                +'</div>'
                +'<div class="col-sm-2">'
                  +'<i onclick="removeName(this,`'+ e.Type.toLowerCase() +'`)" class="fa fa-times" aria-hidden="true"></i>'
                +'</div>'
              +'</div>'
            )
          })
          $('#sumparent').text($('.newparent').size())
          $('#sumpupil').text($('.newpupil').size())
          $('#sumstaff').text($('.newstaff').size())
          $('#sumvisitor').text($('.newvisitor').size())

          $('#tableItemEvent tbody').empty()
          let sumProd = 0
          data.EventFound.products.map(function(e){

            sumProd += e.Price * e.Amount
            $('#tableItemEvent tbody').append(
              '<tr class="lineItemEvent" data-product-id="'+ e.EventProduct_ID +'" data-price-prod="'+ e.Price +'" data-qtd="'+ e.Amount +'">'
                +'<td class="text-center"><i onclick="removeItemEvent(this)" class="fa fa-times" aria-hidden="true"></i></td>'
                +'<td>'+ e.ProductNameEnglish + '/' + e.ProductNamePort + '  |  ' + e.UnitInEnglish + '/' + e.UnitInPort +'</td>'
                +'<td class="text-right">'
                  +'<input onkeyup="updateValueAmont(this);" type="number" min="1" value="'+ e.Amount +'"'
                +'</td>'
                +'<td class="text-right totalProduct">'+ (e.Price * e.Amount).toFixed(2) +'</td>'
              +'</tr>'
            )
          })
          $('#tableItemEvent tbody').append(
            '<tr class="lineTotalGeral">'
              +'<td class="text-right" colspan="4">'+ sumProd.toFixed(2).replace('.',',') +'</td>'
            +'</tr>'
          )
        }
      })
    }
  })

  $('#videoFrom').change(function(e){
    $('#videoTo option').attr('disabled',false)
    document.getElementById('videoTo')
      .options[this.options.selectedIndex]
      .setAttribute('disabled',true)
    $('#videoTo').val('')
  })


  function addItemEvent(){
    if ('' === document.getElementById('qtdProduct').value
     || '' === $('#listProduct').find(":selected").val()) return;

    $('.lineTotalGeral').remove()

    $("#listProduct").select2().find(":selected").each(function(){
      let eventProductID = $(this).data('event-product-id')
      let nomeProdIngl = $(this).data('name-english')
      let nomeProdPort = $(this).data('name-port')
      let unitIngl = $(this).data('name-unit-engl')
      let unitPort = $(this).data('name-unit-port')
      let priceProd = parseFloat($(this).data('price'))
      let qtdProd = parseInt($('#qtdProduct').val())

      $('#tableItemEvent tbody').append(
        '<tr class="lineItemEvent" data-product-id="'+eventProductID+'" data-price-prod="'+priceProd+'" data-qtd="'+qtdProd+'">'
          +'<td class="text-center"><i onclick="removeItemEvent(this)" class="fa fa-times" aria-hidden="true"></i></td>'
          +'<td>'+ nomeProdIngl + '/' + nomeProdPort + '  |  ' + unitIngl + '/' + unitPort +'</td>'
          +'<td class="text-right">'
            +'<input onkeyup="updateValueAmont(this);" type="number" min="1" value="'+ qtdProd +'"'
          +'</td>'
          +'<td class="text-right totalProduct">'+ (priceProd * qtdProd).toFixed(2) +'</td>'
        +'</tr>'
      )
    })

    let sum = 0;
    $('.totalProduct').each(function(){
      sum += parseFloat($(this).text());  // Or this.innerHTML, this.innerText
    });

    $('#tableItemEvent tbody').append(
      '<tr class="lineTotalGeral">'
        +'<td class="text-right" colspan="4">'+ sum.toFixed(2).replace('.',',') +'</td>'
      +'</tr>'
    )
    document.getElementById('qtdProduct').value = ''
    $('#listProduct').val('').trigger("change")

  }

  $('#qtdProduct').keypress(function(e){
    if ( e.which == 13 ){
      e.preventDefault()
      addItemEvent();
    }
  });

  function updateValueAmont(el){
    let newValue = parseInt($(el).val()) * parseFloat($(el).closest('tr').data('price-prod'))
    if($(el).val() === '') newValue = 0
    $(el).closest('tr').find('.totalProduct').text(newValue.toFixed(2))
    $(el).closest('tr').data('qtd',parseInt($(el).val()))

    let sum = 0;
    $('.totalProduct').each(function(){
      sum += parseFloat($(this).text());  // Or this.innerHTML, this.innerText
    });
    $('.lineTotalGeral').find('td').text(sum.toFixed(2))
  }

  function addNameListEvent(novo){
    if ('' === document.getElementById(novo).value) return;
    let newName = document.getElementById(novo).value

    let groupPerson = $('#listTypeName').find(':selected').data('group-name')
    if(17 < newName.length) newName = newName.substr(0,15) + '...'
    $('.lineName[data-group-name="'+groupPerson+'"]').append(
      '<div class="lineGuest new'+groupPerson+'" data-group-name="'+groupPerson+'" data-yourname="'+document.getElementById(novo).value+'">'
        +'<div class="col-sm-10" style="white-space:nowrap;padding-left:0px;padding-right:0px;" data-toggle="tooltip" title="'+document.getElementById(novo).value+'">'
          + newName
        +'</div>'
        +'<div class="col-sm-2">'
          +'<i onclick="removeName(this,`'+groupPerson+'`)" class="fa fa-times" aria-hidden="true"></i>'
        +'</div>'
      +'</div>'
    )
    $('[data-toggle="tooltip"]').tooltip()
    $('#sum'+groupPerson).text($('.new'+groupPerson).size())
    document.getElementById(novo).value = ''
  }

  function removeName(el,groupPerson){
    $(el).parent().parent().remove()
    $('#sum'+groupPerson).text($('.new'+groupPerson).size())
  }

  function removeItemEvent(el){
    $(el).parent().parent().remove()
    let sum = 0;
    $('.totalProduct').each(function(){
      sum += parseFloat($(this).text());  // Or this.innerHTML, this.innerText
    });
    $('.lineTotalGeral td').text(sum.toFixed(2).replace('.',','))
  }

  $('.nParticipant').keyup(function(e){
    let sum = 0
    $('.nParticipant').each(function(){
      if('' !== $(this).val()) sum += parseInt($(this).val())
    })
    $('#qtdTotalParticipant').val('Total: ' + sum)
  })

  $('#nameParticipantNewEvent').keypress(function(e){
    if ( e.which == 13 ){
      e.preventDefault()
      addNameListEvent(this.id)
    }
  })

  $(document).ready(function() {
    $("#roomID").select2()
    $("#responsibleNewEvent").select2()
    $("#selectReuseEvent").select2().on("select2:selecting", function(e) {
       setTimeout(function() { $('#nameNewEvent').focus() }, 50)
    })
    $("#iddepartamento").select2()
    $("#listProduct").select2({
      placeholder: "SELECT THE PRODUCTS"
    })
    $('[data-toggle="tooltip"]').tooltip();

    $("#roomID").change(function(e){
      var curretFullDate = $("#calendar").fullCalendar('getDate');
      var currentMonth = curretFullDate.month() + 1
      var currentYear = curretFullDate.year()
      var idRoom = $("#roomID").val()
      $('#calendar').fullCalendar('removeEvents');
      if('' !== idRoom) searchEvents()
    })

    // setTimeout(function () { $('#roomID').val('551').trigger('change') }, 100);

    $('#calendar').fullCalendar({
      header: {
				left: 'prev,next today',
				center: 'title',
				right: 'month,agendaWeek,agendaDay,listMonth'
		  },
      timezone:'local',
      timeFormat: 'H(:mm)',
      displayEventEnd: true,
      allDaySlot:false,
      dayClick: function(date, jsEvent, view) {
        checkEventPast(date)
        if( '' !== $("#roomID").val() ){
          showModalNewEvent(date)
        }else {
          swal({
            title:"Select the room!",
            text:"First, select the room!",
            type:"info"
          }).then(
            function () {
              $('#roomID').select2('open')
            }
          )
        }
      },
      eventClick: function(calEvent, jsEvent, view) {
        findEventByCode(calEvent.EventCode)
      },viewRender: function (view, element) {
        if( '' !== $("#roomID").val() ) searchEvents()
      },eventRender: function(event, element) {
        element.find(".fc-event-title").remove();
        element.find(".fc-event-time").remove();
        event.description = 'This is a cool event'
        event.id = event.EventID

        if(!event.ResponsibleByName) event.ResponsibleByName = 'Not Reported'
        if(!event.NeedComputer) event.NeedComputer = 'Not Reported'
        if(!event.NeedDataShow) event.NeedDataShow = 'Not Reported'
        if(!event.VideoFrom){
          event.VideoConference = 'Not Reported'
        }else{
          event.VideoConference = event.VideoFrom + ' to ' + event.VideoTo
        }

        var contentPopover = '<div class="row">'
                             + '<div class="col-sm-9">'
                               + '<div class="row">'
                                  + '<div class="col-sm-5">'
                                  + 'Event Name:'
                                  + '</div>'
                                  + '<div class="col-sm-7">'
                                  + toTitleCase(event.title)
                                  + '</div>'
                               + '</div>'
                               + '<div class="row">'
                                  + '<div class="col-sm-5">'
                                  + 'Created By:'
                                  + '</div>'
                                  + '<div class="col-sm-7">'
                                  + toTitleCase(event.CreatedByName)
                                  + '</div>'
                               + '</div>'
                               + '<div class="row">'
                                  + '<div class="col-sm-5">'
                                  + 'Responsible By:'
                                  + '</div>'
                                  + '<div class="col-sm-7">'
                                  + toTitleCase(event.ResponsibleByName)
                                  + '</div>'
                               + '</div>'
                               + '<div class="row">'
                                  + '<div class="col-sm-5">'
                                  + 'Need Computer:'
                                  + '</div>'
                                  + '<div class="col-sm-7">'
                                  + event.NeedComputer
                                  + '</div>'
                               + '</div>'
                               + '<div class="row">'
                                  + '<div class="col-sm-5">'
                                  + 'Need DataShow:'
                                  + '</div>'
                                  + '<div class="col-sm-7">'
                                  + event.NeedDataShow
                                  + '</div>'
                               + '</div>'
                               + '<div class="row">'
                                  + '<div class="col-sm-5">'
                                  + 'Video Conference:'
                                  + '</div>'
                                  + '<div class="col-sm-7">'
                                  + event.VideoConference
                                  + '</div>'
                               + '</div>'
                             + '</div>'
                            //  + '<div class="col-sm-3 text-right">'
                            //    + '<div>'
                            //     + '<button class="btn btn-danger btn-xs">Cancel</button>'
                            //    + '</div>'
                            //    + '<div style="margin-top:5px;">'
                            //    + '<button class="btn btn-success btn-xs">Approve</button>'
                            //    + '</div>'
                            //  + '</div>'
                           + '</div>'

        $(element).popover({html:'true', placement: 'top', container: 'body', title: event.EventCode + ' - ' + event.StatusName, content:contentPopover})
        .addClass('mysuperpopover')
        .on("mouseenter", function () {
            var _this = this;
            $(this).popover("show");
            $(".popover").on("mouseleave", function () {
                $(_this).popover('hide');
            });
        }).on("mouseleave", function () {
            var _this = this;
            setTimeout(function () {
                if (!$(".popover:hover").length) {
                    $(_this).popover("hide");
                }
            }, 0);
        }).on("show.bs.popover", function(){
          $(this).data("bs.popover").tip().css('maxWidth',"600px")
        })
      }
    })
   });

  function searchEvents(){
    if($("#roomID").val() === '') return
    let dataSend = {
      roomID: $("#roomID").val(),
      firstDay: moment($('#calendar').fullCalendar('getView').start).format('YYYY-MM-DD'),
      lastDay: moment($('#calendar').fullCalendar('getView').end).format('YYYY-MM-DD')
    }
    $.ajax({
        url: '/internal-event/search-events',
        type: 'POST',
        data: dataSend,
        dataType:'json',
        success: function(data) {
          $('#calendar').fullCalendar('removeEvents');
          $('#calendar').fullCalendar('addEventSource', data)
        }
    })
  }

  function showModalNewEvent(date){
    $('#roomTitle').text($('#roomID').select2('data')[0].text)
    $('#dateTitle').text(moment(date).format('DD/MM/YYYY'))
    $('#dateNewEvent').val(moment(date).format('YYYY-MM-DD'))
    $('#roomIDNewEvent').val($("#roomID").val())
    $('#modalNewEvent').modal('show')
  }

  $('#modalNewEvent').on('shown.bs.modal', function () {
    $('#startTimeNewEvent').focus();
  })

  $( "#formNewEvent" ).submit(function( e ) {
    e.preventDefault()
    checkEndAfterStart()
    checkStartAfterNow()
    checkNewTimeDay()
    checkVideoConference()
    checkBudgetBalance()
    checkBudgetChoosed()
    addItemUsuarioBurro()
    checkItemWithoutAmount()
    passou()

    let data = $('#formNewEvent').serializeArray()
    data.push({name: 'guests', value: JSON.stringify(serializeGuest())})
    data.push({name: 'products', value: JSON.stringify(serializeTableProduct())})

    $.ajax({
      url: '/internal-event/create-event',
      type: 'POST',
      data,
      dataType:'json',
      success: function(data) {
        $('#submitFormNewEvent').prop("disabled",false);
        $('#submitFormNewEvent').prop("value",'Create');

        // searchEvents()
        // $('#selectReuseEvent').val('').trigger('change')
        // resetForm()

        swal({
          title: "Saved successfully",
          text: data.code,
          type:"success",
          allowOutsideClick: false
        }).then(
          function () {
            if(data.rescheduleEvent === 'No') {
              $('#modalNewEvent').modal('hide')
              window.location.replace('/my-event')
            } else if(data.rescheduleEvent === 'Yes') {
              $('#modalNewEvent').modal('hide')

              $('#rescheduleEventCode').text(data.code)
              $('#rescheduleEventName').text(data.name)
              $('#rescheduleEventStartTime').text(moment(data.date).format('DD-MM-YYYY') + ' ' + data.startTime)
              $('#rescheduleEventEndTime').text(data.endTime)

              $('#eventoToReschedule').val(data.code)
              $('#eventoToRescheduleRoom').val(data.roomID)
              $('#eventoToRescheduleStartTime').val(data.startTime)
              $('#eventoToRescheduleEndTime').val(data.endTime)

              $('#FromDate').attr('min',moment(data.date).add(1, 'days').format('YYYY-MM-DD'))
              $('#ToDate').attr('min',moment(data.date).add(2, 'days').format('YYYY-MM-DD'))

              $('#FromDate').val(moment(data.date).add(1, 'days').format('YYYY-MM-DD'))

              $('#modalRescheduleEvent').modal('show')
            }
          }
        )
      }
    })
  });

  function serializeTableProduct(){
    let arrayProducts = []
    $('#tableItemEvent tbody tr').not(':last').each(function(e){
      let indexObjeto = arrayProducts.findIndex(x => x.productId === $(this).data('productId'))
      if(-1 === indexObjeto){
        arrayProducts.push($(this).data())
      }else{
        arrayProducts[indexObjeto].qtd += $(this).data('qtd')
      }
    })
    return arrayProducts
  }

  function serializeGuest(){
    let arrayGuest = []
    $('.lineGuest').each(function(e){
      arrayGuest.push({
        type: $(this).data('group-name'),
        name: $(this).data('yourname')
      })
    })
    console.log(arrayGuest);
    return arrayGuest
  }

  function checkVideoConference(){
    if (($('#videoFrom').val() !== '') && $('#videoTo').val() === '') {
      swal({
        title:"",
        text:"Video Conference to can\'t be empty",
        type: "info"
      }).then(
        function () {
          $('#videoTo').css('border-color','red')
        }
      )
      throw new Error('Please choose Video Conference to')
    }
  }

  function checkStartAfterNow(){
    let startEvent = moment($('#dateNewEvent').val() + 'T' + $('#startTimeNewEvent').val())
    let now = moment()

    if(startEvent.isBefore(now)){
      swal("Incorrect Time", "Please, choose a start time after now", "error")
      throw new Error('Please, choose a start time after now')
    }
  }

  function checkNewTimeDay(){
    let startEvent = moment($('#dateNewEvent').val() + 'T' + $('#startTimeNewEvent').val())
    let endEvent = moment($('#dateNewEvent').val() + 'T' + $('#endTimeNewEvent').val())
    var isBetween = $('#calendar').fullCalendar( 'clientEvents', function(event){
      if(startEvent.isBetween(event.start, event.end, null, [])
      || endEvent.isBetween(event.start, event.end, null, [])){
        // alert('Horário selecionado já está em uso na Room' + $('#roomID').select2('data')[0].text.split('-').pop())
        swal("Time already selected", "In " + $('#roomID').select2('data')[0].text.split('-').pop(), "error")
        throw new Error('Time + Room already in use.')
      }
    })
  }

  function checkEventPast(dataDesejada){
    if( dataDesejada.format('YYYY-MM-DD') < moment().format('YYYY-MM-DD') ){
      swal("Incorrect Date", "You can\'t create event to previous days", "error")
      throw new Error('Event can\'t be before today.')
    }
  }

  function checkItemWithoutAmount(){
    if(0 < $("#listProduct").select2().find(":selected").size() && '' === $('#qtdProduct').val()){
      swal("Item without amount", "Please, insert the amount of product and press enter", "error")
      throw new Error('Item without amount')
    }
  }

  function addItemUsuarioBurro(){
    if(0 < $("#listProduct").select2().find(":selected").size() && '' !== $('#qtdProduct').val()){
      addItemEvent()
    }
  }

  function checkBudgetBalance(){
    if ($('.lineItemEvent').size() > 0 && '' === $('#id_budget').val()) {
      $('#id_budget').css('border-color','red')
      swal("No Budget Selected", "Please choose an budget", "error")
      throw new Error('Please choose an budget')
    }

    let sum = 0
    $('.totalProduct').each(function(){
      sum += (parseFloat($(this).text()))
    })

    if ($('#id_budget').find(":selected").data('saldo') < sum) {
      $('#id_budget').css('border-color','red')
      swal("Budget doesn't have balance", "Choose another budget or remove itens", "error")
      throw new Error('Please choose an budget')
    }
  }

  function checkBudgetChoosed(){
    if (!$('#id_budget').val()) {
      $('#id_budget').css('border-color','red')
      swal("No Budget Selected", "Please choose an budget", "error")
      throw new Error('Please choose an budget')
    }
  }

  function checkEndAfterStart(){
    let startEvent = moment($('#dateNewEvent').val() + 'T' + $('#startTimeNewEvent').val())
    let endEvent = moment($('#dateNewEvent').val() + 'T' + $('#endTimeNewEvent').val())
    if(startEvent >= endEvent){

      swal("End time must be later than initial", "", "error")
      // alert('Horário Final deve ser após horário inicial')
      throw new Error('Time + Room already in use.')
    }
  }

  function passou(){
    $('#submitFormNewEvent').prop("disabled", true);
    $('#submitFormNewEvent').prop("value",'...creating');
    // alert('passou')
  }

  function findEventByCode(EventCode){
    let data = {EventCode}
    $.ajax({
      url: '/internal-event/find-event-by-code',
      type: 'POST',
      data,
      dataType:'json',
      success: function(eventData) {
        var template = Handlebars.compile(eventData.template);
        $('#divModalMoreInfo').html(template(eventData))
        $('#modalMoreInfoInternal').modal('show')
        console.log(eventData);
      }
    })
  }

  function resetForm(){
    document.getElementById('formNewEvent').reset()
    $('#responsibleNewEvent').val('').trigger('change')
    $('#id_budget').css('border-color','rgb(166, 166, 166)')
    $('#iddepartamento').val('').trigger('change')
    $('#additionalInformation').text('')
    $('.lineName').empty()
    $('#sumparent').text(0)
    $('#sumpupil').text(0)
    $('#sumstaff').text(0)
    $('#sumvisitor').text(0)
    $('#tableItemEvent tbody').empty()
  }

  function updateMinToDateField(el){
    $('#ToDate').attr('min',moment($(el).val()).add(1, 'days').format('YYYY-MM-DD'))
  }

  $('#formReschedule').submit(function(e){
    e.preventDefault()
    validateCheckBoxWeek()
    genereateArrayDates()
  })

  function validateCheckBoxWeek(){
    $('input[type=checkbox][name=dayOfWeek]').css('outline','1px solid #FFF')
    if(0 === $('input[type=checkbox][name=dayOfWeek]:checked').size()){
      swal({
        title: "",
        text: "Please select at least ONE day of week",
        type: "error"
      }).then(
        function () {
          $('input[type=checkbox][name=dayOfWeek]').css('outline','1px solid red')
        }
      )
      throw new Error('Please select at least ONE day of week')
    }
  }

  function genereateArrayDates(){
    let arrayWeekDay = []
    $("input[type=checkbox][name=dayOfWeek]:checked").each(function(){
      arrayWeekDay.push(parseInt($(this).val()))
    })

    let a = moment($('#FromDate').val())
    let b = moment($('#ToDate').val())

    let arrayDatesDesired = []
    for (let m = moment(a); m.isSameOrBefore(b); m.add(1, 'days')){
      if( arrayWeekDay.includes(m.day()) ){
        arrayDatesDesired.push({
          // "dateDefaultStart": m.format('YYYY-MM-DD') + 'T' + moment($('#StartEvent').val()).format('HH:mm'),
          // "dateDefaultEnd": m.format('YYYY-MM-DD') + 'T' + moment($('#EndEvent').val()).format('HH:mm'),
          "dateFormated": m.format('DD/MM/YYYY') + ' - ' + convertToDayString(m.day()),
          "dateStart": m.format('YYYY-MM-DD') + 'T' + $('#eventoToRescheduleStartTime').val(),
          "dateEnd": m.format('YYYY-MM-DD') + 'T' + $('#eventoToRescheduleEndTime').val(),
          "weekDay": convertToDayString(m.day())
        })
      }
    }

    $.ajax({
      url: '/reschedule/verify-dates',
      type: 'POST',
      data: {
        "EventCode": parseInt($('#eventoToReschedule').val()),
        "Room_ID": parseInt($('#eventoToRescheduleRoom').val()),
        "desiredDate": JSON.stringify(arrayDatesDesired)
      },
      dataType:'json',
      success: function(data) {
        console.log(data)

        $('#divRangeDate').css('display','block')
        if(0 === data.length){
          $('#amountEvent').text(0)
          let msgZeroData = '<div class="alert alert-danger" style="margin-bottom:0px;">'+
            '<strong>No dates!</strong> Please, make a valid filter.'+
          '</div>'

          $('#listDesiredDates').html(msgZeroData)
        }else{
          $('#amountEvent').text(data.length)

          $('#listDesiredDates').empty()
          $('#listDesiredDates').append('<ul style="margin-bottom:0px;"></ul>')

          data.forEach(function(e){
            let newLineDate = ''
            if(e.Available){
              newLineDate = '<li class="newEvent" data-available="' + e.Available + '" data-date-start="' + e.dateStart + '" data-date-end="' + e.dateEnd + '" data-weekday="'+ e.weekDay + '" >' +
                            '<span class="label label-success">Rescheduled</span> - ' + e.dateFormated + '</li>'
            }else{
              let labels = ''
              e.EventsSameTime.forEach((element, index) => {
                let start = moment(element.StartEvent).format('HH:mm')
                let end = moment(element.EndEvent).format('HH:mm')
                let tooltip = element.Name + '<div>' + toTitleCase(element.CreateByName) + '</div><div>' + start + ' - ' + end + '</div>'
                labels += '<span style="margin-right: 3px;" data-toggle="tooltip" title="" data-original-title="' + tooltip + '" class="label label-danger">' + element.EventCode + '</span>'
              })

              newLineDate = '<li class="newEvent" data-available="' + e.Available + '" data-date-start="' + e.dateStart + '" data-date-end="' + e.dateEnd + '" data-weekday="'+ e.weekDay + '" >' +
                            labels + ' - ' + e.dateFormated + '</li>'
            }
            $('#listDesiredDates ul').append(newLineDate)
          })
          $('[data-toggle="tooltip"]').tooltip({html:true})
        }
      }
    })
  }

  function toTitleCase(str) {
    str = str || ''
    return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
  }

  function convertToDayString(numberDay){
    let weekday = []
    weekday[0] =  "Sunday";
    weekday[1] =  "Monday";
    weekday[2] =  "Tuesday";
    weekday[3] =  "Wednesday";
    weekday[4] =  "Thursday";
    weekday[5] =  "Friday";
    weekday[6] =  "Saturday";
    return weekday[numberDay]
  }

  function confirmCreation(){
    if(0 === $('.newEvent').size()){
      swal({
        title: "",
        text: "No dates selected",
        type: "error"
      }).then(function() {})
      throw new Error('No dates selected')
    }else{
      let dataSend = {
        "EventCode": parseInt($('#eventoToReschedule').val()),
        "Room_ID": parseInt($('#eventoToRescheduleRoom').val()),
        "dateNewEvent": moment($('#listDesiredDates ul li[data-available="true"]').data('date-start')).format('YYYY-MM-DD HH:mm:ss'),
        "desiredDate": JSON.stringify(serializeDesiredDate())
      }

      $.ajax({
        url: '/reschedule/create',
        type: 'POST',
        data: dataSend,
        dataType:'json',
        success: function(data) {
          // $('#listDesiredDates').empty()
          // $('#listDesiredDates').append('<ul style="margin-bottom:0px;"></ul>')
          // console.log(data)
          // data.forEach(function(e){
          //   if(e.Available){
          //     $('#listDesiredDates ul').append('<li class="newEvent" data-date-start="'+ e.dateStart +'" data-date-end="'+ e.dateEnd +'" data-weekday="'+ e.weekday +'" >'+
          //       '<span class="label label-success">Rescheduled</span> - ' + moment(e.dateStart).format('DD/MM/YYYY') + ' - ' + e.weekday +
          //     '</li>')
          //   }else{
          //     $('#listDesiredDates ul').append('<li class="newEvent" data-date-start="'+ e.dateStart +'" data-date-end="'+ e.dateEnd +'" data-weekday="'+ e.weekday +'" >'+
          //       '<span class="label label-danger">' + e.EventScheduled.EventCode + '</span> - ' + moment(e.dateStart).format('DD/MM/YYYY') + ' - ' + e.weekday +
          //     '</li>')
          //   }
          // })
        }
      })
    }
  }

  function serializeDesiredDate(){
    let arrayDesiredDate = []
    $('.newEvent').each(function(e){
      arrayDesiredDate.push($(this).data())
    })
    return arrayDesiredDate
  }
</script>
{{/section}}
