{{#section 'functionality'}}
  {{#each sess.functionalityProfile}}
    <li><a href="{{Action}}"><i class="fa {{Icon}}"></i> {{Name}} </a></li>
  {{/each}}
{{/section}}

<div class="row">
  <div class="col-sm-6">
    <select id="roomID" class="btn-block" name="getAllSiteBuildingRoom" >
      <option value="">SELECT THE ROOM</option>
      {{#each getAllSiteBuildingRoom}}
        <option value="{{RoomID}}">{{unidade}} - {{NameBuilding}} - {{NameRoom}}</option>
      {{/each}}
    </select>
  </div>
</div>

<div class="row" style="margin-top:5px;">
  <div class="col-md-12">
    <div class="x_panel">
      <div class="x_content">
        <div id="calendar"></div>
      </div>
    </div>
  </div>
</div>

<div id="modalNewEvent" class="modal fade" role="dialog">
  <div class="modal-dialog" style="width:90%;">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h5 class="modal-title">New Internal Event - <span id="dateTitle"></span> in <span id="roomTitle"></span></h5>
      </div>
      <form id="formNewEvent" action="index.html" method="post">
        <input type="hidden" name="dateNewEvent" id="dateNewEvent">
        <input type="hidden" name="roomIDNewEvent" id="roomIDNewEvent">
        <div class="modal-body">
          <div class="container">
            <div class="col-sm-1">
              <label for="startTimeNewEvent">Start</label>
              <input type="time" name="startTimeNewEvent" id="startTimeNewEvent" class="form-control" required>
            </div>
            <div class="col-sm-1">
              <label for="endTimeNewEvent">End</label>
              <input type="time" name="endTimeNewEvent" id="endTimeNewEvent" class="form-control" required>
            </div>
            <div class="col-sm-4">
              <label for="nameNewEvent"> </label>
              <input type="text" name="nameNewEvent" id="nameNewEvent" class="form-control" placeholder=" Event Name" required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <input type="submit" value="Create" class="btn btn-success">
        </div>
      </form>
    </div>
  </div>
</div>

{{#section 'script'}}
<script type="text/javascript">

  $(document).ready(function() {
    $("#roomID").select2();

    $("#roomID").change(function(e){
      var curretFullDate = $("#calendar").fullCalendar('getDate');
      var currentMonth = curretFullDate.month() + 1
      var currentYear = curretFullDate.year()
      var idRoom = $("#roomID").val()
      $('#calendar').fullCalendar('removeEvents');
      if('' !== idRoom) searchEvents()
    })

    setTimeout(function () { $('#roomID').val('551').trigger('change') }, 100);

    $('#calendar').fullCalendar({
      header: {
				left: 'prev,next today',
				center: 'title',
				right: 'month,agendaWeek,agendaDay,listMonth'
		  },
      timezone:'local',
      timeFormat: 'H(:mm)',
      displayEventEnd: true,
      allDaySlot:false,
      dayClick: function(date, jsEvent, view) {
        ( '' !== $("#roomID").val() ) ? showModalNewEvent(date) : alert('--click day without room. Please, select the Room.')
      },
      eventClick: function(calEvent, jsEvent, view) {

      },viewRender: function (view, element) {
        if( '' !== $("#roomID").val() ) searchEvents()
      },eventRender: function(event, element) {
        element.find(".fc-event-title").remove();
        element.find(".fc-event-time").remove();
        event.description = 'This is a cool event'
        event.id = event.EventID
        var tooltip = '<div class="text-left">Nome do Evento: XXXX teste' + '<br />'
                      + '<span style="color:yellow;">Date: XXXX teste</span>' + '<br />'
                      + 'Start Time: 10:00' + '<br />'
                      + 'End Time: 12:00' + '<br />'
                      + 'Nome do Evento: XXXX teste</div>'
        $(element).attr("data-original-title", tooltip)
        $(element).tooltip({ container: "body",html:'true'})
      }
    })
   });

  function searchEvents(){
    if($("#roomID").val() === '') return
    let dataSend = {
      roomID: $("#roomID").val(),
      firstDay: moment($('#calendar').fullCalendar('getView').start).format('YYYY-MM-DD'),
      lastDay: moment($('#calendar').fullCalendar('getView').end).format('YYYY-MM-DD')
    }
    $.ajax({
        url: '/internal-event/search-events',
        type: 'POST',
        data: dataSend,
        dataType:'json',
        success: function(data) {
          $('#calendar').fullCalendar('removeEvents');
          $('#calendar').fullCalendar('addEventSource', data)
        }
    })
  }

  function showModalNewEvent(date){
    $('#roomTitle').text($('#roomID').select2('data')[0].text)
    $('#dateTitle').text(moment(date).format('DD/MM/YYYY'))
    $('#dateNewEvent').val(moment(date).format('YYYY-MM-DD'))
    $('#roomIDNewEvent').val($("#roomID").val())
    $('#modalNewEvent').modal('show')
    populateToTest()
  }

  $('#modalNewEvent').on('shown.bs.modal', function () {
    $('#startTimeNewEvent').focus();
  })

  function populateToTest(){
    $('#startTimeNewEvent').val('10:00')
    $('#endTimeNewEvent').val('11:00')
    $('#nameNewEvent').val('nome evento teste')
  }

  $( "#formNewEvent" ).submit(function( e ) {
    e.preventDefault();
    checkNewTimeDay();
  });

  function checkNewTimeDay(){
    let startEvent = moment($('#dateNewEvent').val() + 'T' +  $('#startTimeNewEvent').val())
    let endEvent = moment($('#dateNewEvent').val() + 'T' +  $('#endTimeNewEvent').val())

    var dayEvents = $('#calendar').fullCalendar( 'clientEvents', function(event){
      // return moment(event.start).isSame($('#dateNewEvent').val(),'day')
      //   && target.isBetween(start, finish, 'days', '[]')
      //   && target.isBetween(start, finish, 'days', '[]')
      return startEvent.isBetween(event.start, event.end, null, [])
          || endEvent.isBetween(event.start, event.end, null, [])
    });
    console.log(dayEvents);
  }
</script>
{{/section}}
