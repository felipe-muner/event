{{#section 'functionality'}}
  {{#each sess.functionalityProfile}}
    <li><a href="{{Action}}"><i class="fa {{Icon}}"></i> {{Name}} </a></li>
  {{/each}}
{{/section}}

{{#section 'head'}}
  <style media="screen">
  .select2-container .select2-search,
    .select2-container .select2-search__field {
        width: 100% !important;
    }
  </style>
{{/section}}

<div class="row">
  <div class="col-sm-6">
    <select id="roomID" name="getAllSiteBuildingRoom" style="width:100%;">
      <option value="">SELECT THE ROOM</option>
      {{#each getAllSiteBuildingRoom}}
        <option value="{{RoomID}}">{{unidade}} - {{NameBuilding}} - {{NameRoom}}</option>
      {{/each}}
    </select>
  </div>
</div>

<div class="row" style="margin-top:15px;">
  <div class="col-md-12">
    <div class="x_panel">
      <div class="x_content">
        <div id="calendar"></div>
      </div>
    </div>
  </div>
</div>

<div id="modalNewEvent" class="modal fade" role="dialog">
  <div class="modal-dialog" style="width:90%;">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h5 class="modal-title">New Internal Event - <span id="dateTitle"></span> in <span id="roomTitle"></span></h5>
      </div>
      <form id="formNewEvent" action="index.html" method="post">
        <input type="hidden" name="dateNewEvent" id="dateNewEvent">
        <input type="hidden" name="roomIDNewEvent" id="roomIDNewEvent">
        <div class="modal-body">
          <div class="container">
            <div class="row">
              <div class="col-sm-12">
                <div class="panel panel-primary">
                  <div class="panel-heading">Main information</div>
                  <div class="panel-body">
                    <div class="row">
                      <div class="col-sm-1">
                        <label for="startTimeNewEvent">Start</label>
                        <input type="time" name="startTimeNewEvent" id="startTimeNewEvent" class="form-control" required>
                      </div>
                      <div class="col-sm-1">
                        <label for="endTimeNewEvent">End</label>
                        <input type="time" name="endTimeNewEvent" id="endTimeNewEvent" class="form-control" required>
                      </div>
                      <div class="col-sm-4">
                        <label for="nameNewEvent"></label>
                        <input type="text" name="nameNewEvent" id="nameNewEvent" class="form-control" placeholder=" Event Name" required>
                      </div>
                      <div class="col-sm-3">
                        <label for="responsibleNewEvent"></label>
                        <select id="responsibleNewEvent" name="responsibleNewEvent" style="width:100%;">
                          <option value="">RESPONSIVE BY EVENT</option>
                          {{#each allActiveUser}}
                            <option value="{{idusuario}}">{{nomeusuario}}</option>
                          {{/each}}
                        </select>
                      </div>
                      <div class="col-sm-3">
                        <label for="iddepartamento"></label>
                        <select id="iddepartamento" name="iddepartamento" style="width:100%;">
                          <option value="">SELECT THE DEPARTAMENT</option>
                          {{#each allDepartament}}
                            <option value="{{iddepartamento}}">{{nomedepartamento}}</option>
                          {{/each}}
                        </select>
                      </div>
                    </div>
                    <div class="row">

                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row" style="margin-top:5px;">
              <div class="col-sm-6">
                <div class="panel panel-primary">
                  <div class="panel-heading">Participants</div>
                  <div class="panel-body">
                    <div class="row">
                      <div class="col-sm-2">
                        <input type="number" min="0" name="qtdParentNewEvent" id="qtdParentNewEvent" class="form-control nParticipant" placeholder=" Nº Parent" style="padding-right: 2px;" data-toggle="tooltip" title="Nº Parent">
                      </div>
                      <div class="col-sm-2">
                        <input type="number" min="0" name="qtdPupilNewEvent" id="qtdPupilNewEvent" class="form-control nParticipant" placeholder=" Nº Pupil" data-toggle="tooltip" title="Nº Pupil">
                      </div>
                      <div class="col-sm-2">
                        <input type="number" min="0" name="qtdStaffNewEvent" id="qtdStaffNewEvent" class="form-control nParticipant" placeholder=" Nº Staff" data-toggle="tooltip" title="Nº Staff">
                      </div>
                      <div class="col-sm-2">
                        <input type="number" min="0" name="qtdVisitorNewEvent" id="qtdVisitorNewEvent" class="form-control nParticipant" placeholder=" Nº Visitor" data-toggle="tooltip" title="Nº Visitor">
                      </div>
                      <div class="col-sm-4">
                        <input type="text" min="0" name="qtdTotalParticipant" id="qtdTotalParticipant" class="form-control" placeholder=" Total" disabled style="text-align: right;">
                      </div>
                    </div>
                    <div class="row" style="margin-top:5px;">
                      <div class="col-sm-2">
                        <select class="form-control" id="listTypeName">
                          <option data-group-name="parent" value="Parent">Parent</option>
                          <option data-group-name="pupil" value="Pupil">Pupil</option>
                          <option data-group-name="staff" value="Staff">Staff</option>
                          <option data-group-name="visitor" value="Visitor">Visitor</option>
                        </select>
                      </div>
                        <div class="col-sm-10">
                          <input type="text" name="nameParticipantNewEvent" id="nameParticipantNewEvent" class="form-control" placeholder=" Insert name and press enter">
                        </div>
                    </div>
                    <div class="col-sm-12" style="margin-top:10px;">
                      <div class="row">
                        <div class="col-sm-3 text-center">
                          <button type="button" class="btn btn-primary" style="padding-top: 0px;padding-bottom: 0px;margin-bottom:3px;">Parent <span id="sumparent" class="badge">0</span></button>
                        </div>
                        <div class="col-sm-3 text-center">
                          <button type="button" class="btn btn-primary" style="padding-top: 0px;padding-bottom: 0px;margin-bottom:3px;">Pupil <span id="sumpupil" class="badge">0</span></button>
                        </div>
                        <div class="col-sm-3 text-center">
                          <button type="button" class="btn btn-primary" style="padding-top: 0px;padding-bottom: 0px;margin-bottom:3px;">Staff <span id="sumstaff" class="badge">0</span></button>
                        </div>
                        <div class="col-sm-3 text-center">
                          <button type="button" class="btn btn-primary" style="padding-top: 0px;padding-bottom: 0px;margin-bottom:3px;">Visitor <span id="sumvisitor" class="badge">0</span></button>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-sm-3 lineName" data-group-name="parent" style="padding-left:0px;">
                        </div>
                        <div class="col-sm-3 lineName" data-group-name="pupil" style="padding-left:0px;">
                        </div>
                        <div class="col-sm-3 lineName" data-group-name="staff" style="padding-left:0px;">
                        </div>
                        <div class="col-sm-3 lineName" data-group-name="visitor" style="padding-left:0px;">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="panel panel-primary">
                  <div class="panel-heading">Menu</div>
                  <div class="panel-body">
                    <div class="row">
                      <div class="col-sm-2">
                        <select id="id_budget" name="id_budget" style="width:100%;">
                          <option></option>
                          <!-- {{#each allProductActive}}
                            <option data-name-english="{{NameEnglish}}" data-name-port="{{NamePort}}" data-name-unit-engl="{{NameUnitEngl}}" data-name-unit-port="{{NameUnitPort}}" data-price={{Price}} data-event-product-id="{{EventProductID}}" value="{{EventProductID}}">{{NameEnglish}}/{{NamePort}} | {{NameUnitEngl}}/{{NameUnitPort}} | R$ {{Price}}</option>
                          {{/each}} -->
                        </select>
                      </div>
                      <div class="col-sm-8">
                        <select id="listProduct" name="allProductActive" multiple style="width:100%;">
                          <option></option>
                          {{#each allProductActive}}
                            <option data-name-english="{{NameEnglish}}" data-name-port="{{NamePort}}" data-name-unit-engl="{{NameUnitEngl}}" data-name-unit-port="{{NameUnitPort}}" data-price={{Price}} data-event-product-id="{{EventProductID}}" value="{{EventProductID}}">{{NameEnglish}}/{{NamePort}} | {{NameUnitEngl}}/{{NameUnitPort}} | R$ {{Price}}</option>
                          {{/each}}
                        </select>
                      </div>
                      <div class="col-sm-2">
                        <input type="number" min="0" name="qtdProduct" id="qtdProduct" class="form-control" style="height:33px;" title="Insert amount and press enter" data-toggle="tooltip">
                      </div>
                    </div>
                    <div class="row" style="margin-top:10px;">
                      <div class="col-sm-12">
                        <div class="table-responsive">
                          <table class="table" id="tableItemEvent" style="margin-bottom: 0px;">
                            <thead>
                              <th style="width:5%;border-right: 1px solid white;">Remove</th>
                              <th style="width:65%;border-right: 1px solid white;">Product</th>
                              <th style="width:10%;border-right: 1px solid white;">Amount</th>
                              <th style="width:20%;">Total (R$)</th>
                            </thead>
                            <tbody>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <input type="submit" value="Create" class="btn btn-success">
        </div>
      </form>
    </div>
  </div>
</div>

{{#section 'script'}}
<script type="text/javascript">

  function addItemEvent(){
    if ('' === document.getElementById('qtdProduct').value
     || '' === $('#listProduct').find(":selected").val()) return;

    $('.lineTotalGeral').remove()

    $("#listProduct").select2().find(":selected").each(function(){
      let eventProductID = $(this).data('event-product-id')
      let nomeProdIngl = $(this).data('name-english')
      let nomeProdPort = $(this).data('name-port')
      let unitIngl = $(this).data('name-unit-engl')
      let unitPort = $(this).data('name-unit-port')
      let priceProd = parseFloat($(this).data('price'))
      let qtdProd = parseInt($('#qtdProduct').val())

      $('#tableItemEvent tbody').append(
        '<tr data-product-id="'+eventProductID+'" data-price-prod="'+priceProd+'" data-qtd="'+qtdProd+'">'
          +'<td class="text-center"><i onclick="removeItemEvent(this)" class="fa fa-times" aria-hidden="true"></i></td>'
          +'<td>'+ nomeProdIngl + '/' + nomeProdPort + '  |  ' + unitIngl + '/' + unitPort +'</td>'
          +'<td class="text-right">'
            +'<input onkeyup="updateValueAmont(this);" type="number" min="1" value="'+ qtdProd +'"'
          +'</td>'
          +'<td class="text-right totalProduct">'+ (priceProd * qtdProd).toFixed(2) +'</td>'
        +'</tr>'
      )
    })

    let sum = 0;
    $('.totalProduct').each(function(){
      sum += parseFloat($(this).text());  // Or this.innerHTML, this.innerText
    });

    $('#tableItemEvent tbody').append(
      '<tr class="lineTotalGeral">'
        +'<td class="text-right" colspan="4">'+ sum.toFixed(2).replace('.',',') +'</td>'
      +'</tr>'
    )
  }

  $('#qtdProduct').keypress(function(e){
    if ( e.which == 13 ){
      e.preventDefault()
      addItemEvent();
    }
  });

  function updateValueAmont(el){
    let newValue = parseInt($(el).val()) * parseFloat($(el).closest('tr').data('price-prod'))
    if($(el).val() === '') newValue = 0
    $(el).closest('tr').find('.totalProduct').text(newValue.toFixed(2))
    $(el).closest('tr').data('qtd',parseInt($(el).val()))

    let sum = 0;
    $('.totalProduct').each(function(){
      sum += parseFloat($(this).text());  // Or this.innerHTML, this.innerText
    });
    $('.lineTotalGeral').find('td').text(sum.toFixed(2))

  }


  function addNameListEvent(novo){
    if ('' === document.getElementById(novo).value) return;
    let newName = document.getElementById(novo).value

    let groupPerson = $('#listTypeName').find(':selected').data('group-name')
    if(17 < newName.length) newName = newName.substr(0,15) + '...'
    $('.lineName[data-group-name="'+groupPerson+'"]').append(
      '<div class="lineGuest new'+groupPerson+'" data-group-name="'+groupPerson+'">'
        +'<div class="col-sm-10" style="white-space:nowrap;padding-left:0px;padding-right:0px;" data-toggle="tooltip" title="'+document.getElementById(novo).value+'">'
          + newName
        +'</div>'
        +'<div class="col-sm-2">'
          +'<i onclick="removeName(this,`'+groupPerson+'`)" class="fa fa-times" aria-hidden="true"></i>'
        +'</div>'
      +'</div>'
    )
    $('[data-toggle="tooltip"]').tooltip();
    $('#sum'+groupPerson).text($('.new'+groupPerson).size())
    document.getElementById(novo).value = ''
  }

  function removeName(el,groupPerson){
    $(el).parent().parent().remove()
    $('#sum'+groupPerson).text($('.new'+groupPerson).size())
  }

  function removeItemEvent(el){
    $(el).parent().parent().remove()
    let sum = 0;
    $('.totalProduct').each(function(){
      sum += parseFloat($(this).text());  // Or this.innerHTML, this.innerText
    });
    $('.lineTotalGeral td').text(sum.toFixed(2).replace('.',','))
  }

  $('.nParticipant').keyup(function(e){
    let sum = 0
    $('.nParticipant').each(function(){
      if('' !== $(this).val()) sum += parseInt($(this).val())
    })
    $('#qtdTotalParticipant').val('Total: ' + sum)
  })

  $('#nameParticipantNewEvent').keypress(function(e){
    if ( e.which == 13 ){
      e.preventDefault()
      addNameListEvent(this.id)
    }
  });

  $(document).ready(function() {
    $("#roomID").select2()
    $("#responsibleNewEvent").select2()
    $("#iddepartamento").select2()
    $("#listProduct").select2({
      placeholder: "SELECT THE PRODUCTS",
      allowClear: true
    })
    $('[data-toggle="tooltip"]').tooltip();

    $("#roomID").change(function(e){
      var curretFullDate = $("#calendar").fullCalendar('getDate');
      var currentMonth = curretFullDate.month() + 1
      var currentYear = curretFullDate.year()
      var idRoom = $("#roomID").val()
      $('#calendar').fullCalendar('removeEvents');
      if('' !== idRoom) searchEvents()
    })

    setTimeout(function () { $('#roomID').val('551').trigger('change') }, 100);

    $('#calendar').fullCalendar({
      header: {
				left: 'prev,next today',
				center: 'title',
				right: 'month,agendaWeek,agendaDay,listMonth'
		  },
      timezone:'local',
      timeFormat: 'H(:mm)',
      displayEventEnd: true,
      allDaySlot:false,
      dayClick: function(date, jsEvent, view) {
        ( '' !== $("#roomID").val() ) ? showModalNewEvent(date) : alert('--click day without room. Please, select the Room.')
      },
      eventClick: function(calEvent, jsEvent, view) {

      },viewRender: function (view, element) {
        if( '' !== $("#roomID").val() ) searchEvents()
      },eventRender: function(event, element) {
        element.find(".fc-event-title").remove();
        element.find(".fc-event-time").remove();
        event.description = 'This is a cool event'
        event.id = event.EventID
        var tooltip = '<div class="text-left">Nome do Evento: XXXX teste' + '<br />'
                      + '<span style="color:yellow;">Date: XXXX teste</span>' + '<br />'
                      + 'Start Time: 10:00' + '<br />'
                      + 'End Time: 12:00' + '<br />'
                      + 'EventID: ' + event.EventID + '<br />'
                      + 'Nome do Evento: XXXX teste</div>'
        $(element).attr("data-original-title", tooltip)
        $(element).tooltip({ container: "body",html:'true'})
      }
    })
   });

  function searchEvents(){
    if($("#roomID").val() === '') return
    let dataSend = {
      roomID: $("#roomID").val(),
      firstDay: moment($('#calendar').fullCalendar('getView').start).format('YYYY-MM-DD'),
      lastDay: moment($('#calendar').fullCalendar('getView').end).format('YYYY-MM-DD')
    }
    $.ajax({
        url: '/internal-event/search-events',
        type: 'POST',
        data: dataSend,
        dataType:'json',
        success: function(data) {
          $('#calendar').fullCalendar('removeEvents');
          $('#calendar').fullCalendar('addEventSource', data)
        }
    })
  }

  function showModalNewEvent(date){
    $('#roomTitle').text($('#roomID').select2('data')[0].text)
    $('#dateTitle').text(moment(date).format('DD/MM/YYYY'))
    $('#dateNewEvent').val(moment(date).format('YYYY-MM-DD'))
    $('#roomIDNewEvent').val($("#roomID").val())
    $('#modalNewEvent').modal('show')
    populateToTest()
  }

  $('#modalNewEvent').on('shown.bs.modal', function () {
    $('#startTimeNewEvent').focus();
  })

  function populateToTest(){
    $('#startTimeNewEvent').val('10:00')
    $('#endTimeNewEvent').val('11:00')
    $('#nameNewEvent').val('nome evento teste')
  }

  $( "#formNewEvent" ).submit(function( e ) {
    e.preventDefault()
    checkEndAfterStart()
    checkNewTimeDay()
    passou()

    let data = $('#formNewEvent').serializeArray()

    data.push({name: 'guests', value: serializeGuest()});
    data.push({name: 'products', value: JSON.stringify(serializeTableProduct())});

    $.ajax({
      url: '/internal-event/create-event',
      type: 'POST',
      data,
      dataType:'json',
      success: function(data) {
        alert('Gravado com Sucesso')
        searchEvents()
      }
    })
  });

  function serializeTableProduct(){
    let arrayProducts = []
    $('#tableItemEvent tbody tr').not(':last').each(function(e){
      arrayProducts.push($(this).data())
    })
    return arrayProducts
  }

  function serializeGuest(){
    return 'guest still with nothing'
  }

  function checkNewTimeDay(){
    let startEvent = moment($('#dateNewEvent').val() + 'T' + $('#startTimeNewEvent').val())
    let endEvent = moment($('#dateNewEvent').val() + 'T' + $('#endTimeNewEvent').val())
    var isBetween = $('#calendar').fullCalendar( 'clientEvents', function(event){
      if(startEvent.isBetween(event.start, event.end, null, [])
      || endEvent.isBetween(event.start, event.end, null, [])){
        alert('Horário selecionado já está em uso na Room' + $('#roomID').select2('data')[0].text.split('-').pop())
        throw new Error('Time + Room already in use.')
      }
    })
  }

  function checkEndAfterStart(){
    let startEvent = moment($('#dateNewEvent').val() + 'T' + $('#startTimeNewEvent').val())
    let endEvent = moment($('#dateNewEvent').val() + 'T' + $('#endTimeNewEvent').val())
    if(startEvent >= endEvent){
      alert('Horário Final deve ser após horário inicial')
      throw new Error('Time + Room already in use.')
    }
  }

  function passou(){
    alert('passou')
  }
</script>
{{/section}}
